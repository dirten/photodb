#!/usr/bin/perl -wT

# Interactive user interface for interacting with the photography database

use strict;
use warnings;
use Switch;
use DBI;
use DBD::mysql;
use SQL::Abstract;

use lib 'lib';
use funcs;
use queries;
use handlers;

# Connect to DB - for now this is a global
my $db = &db;

# Define handlers for each command
my %handlers = (
	'film' => {
		'add' => {
			'desc' => 'Add a new film to the database',
			'handler' => \&film_add,
		},
		'load' => {
			'desc' => 'Load a film into a camera',
			'handler' => \&film_load,
		},
		'develop' => {
			'desc' => 'Develop a film',
			'handler' => \&film_develop,
		},
		'tag' => {
			'desc' => 'Write EXIF tags to scans from a film',
			'handler' => \&film_tag,
		},
		'archive' => {
			'desc' => 'Put the film in a physical archive',
			'handler' => \&film_archive,
		},
		'locate' => {
			'desc' => 'Locate where this film is',
			'handler' => \&film_locate
		}
	},
	camera => {
		'add' => {
			'desc' => 'Add a new camera to the database',
			'handler' => \&camera_add,
		},
		'display-lens' => {
			'desc' => 'Associate a camera with a lens for display purposes',
			'handler' => \&camera_displaylens,
		},
		'show-lenses' => {
			'desc' => 'Not yet implemented',
			'handler' => \&notimplemented,
		},
		'sell' => {
			'desc' => 'Sell a camera',
			'handler' => \&camera_sell,
		},
		'repair' => {
			'desc' => 'Repair a camera',
			'handler' => \&camera_repair,
		},
		'addbodytype' => {
			'desc' => 'Add a new camera body type',
			'handler' => \&camera_addbodytype
		}
	},
	negative => {
		'add' => {
			'desc' => 'Add a new negative to the database as part of a film',
			'handler' => \&negative_add,
		},
		'bulk-add' => {
			'desc' => 'Bulk add multiple negatives to the database as part of a film',
			'handler' => \&negative_bulkadd
		}
	},
	mount => {
		'add' => {
			'desc' => 'Add a new lens mount to the database',
			'handler' => \&mount_add,
		},
		'view' => {
			'desc' => 'View compatible cameras and lenses for a mount',
			'handler' => \&mount_view,
		},
		'adapt' => {
			'desc' => 'Add a new mount adapter to the database',
			'handler' => \&mount_adapt
		}
	},
	lens => {
		'add' => {
			'desc' => 'Add a new lens to the database',
			'handler' => \&lens_add,
		},
		'sell' => {
			'desc' => 'Sell a lens',
			'handler' => \&lens_sell,
		},
		'repair' => {
			'desc' => 'Repair a lens',
			'handler' => \&lens_repair
		}
	},
	print => {
		'add' => {
			'desc' => 'Add a new print that has been made from a negative',
			'handler' => \&print_add,
		},
		'tone' => {
			'desc' => 'Add toning to a print',
			'handler' => \&print_tone,
		},
		'sell' => {
			'desc' => 'Sell a print',
			'handler' => \&print_sell,
		},
		'order' => {
			'desc' => 'Register an order for a print',
			'handler' => \&print_order,
		},
		'fulfil' => {
			'desc' => 'Fulfil an order for a print',
			'handler' => \&print_fulfil,
		},
		'archive' => {
			'desc' => 'Add a print to a physical archive',
			'handler' => \&print_archive,
		},
		'locate' => {
			'desc' => 'Locate a print in an archive',
			'handler' => \&print_locate
		}
	},
	paperstock => {
		'add' => {
			'desc' => 'Add a new type of photo paper to the database',
			'handler' => \&paperstock_add
		}
	},
	developer => {
		'add' => {
			'desc' => 'Add a new developer to the database',
			'handler' => \&developer_add
		}
	},
	toner => {
		'add' => {
			'desc' => 'Add a new chemical toner to the database',
			'handler' => \&toner_add
		}
	},
	task => {
		'run' => {
			'desc' => 'Run a selection of maintenance tasks on the database',
			'handler' => \&task_run
		}
	},
	filmstock => {
		'add' => {
			'desc' => 'Add a new type of filmstock to the database',
			'handler' => \&filmstock_add
		}
	},
	teleconverter => {
		'add' => {
			'desc' => 'Add a new teleconverter to the database',
			'handler' => \&teleconverter_add
		}
	},
	filter => {
		'add' => {
			'desc' => 'Add a new (optical) filter to the database',
			'handler' => \&filter_add,
		},
		'adapt' => {
			'desc' => 'Add a filter adapter to the database',
			'handler' => \&filter_adapt
		}
	},
	manufacturer => {
		'add' => {
			'desc' => 'Add a new manufacturer to the database',
			'handler' => \&manufacturer_add
		}
	},
	accessory => {
		'add' => {
			'desc' => 'Add a new accessory to the database',
			'handler' => \&accessory_add,
		},
		'list' => {
			'desc' => 'Not yet implemented',
			'handler' => \&notimplemented,
		},
		'type' => {
			'desc' => 'Add a new type of accessory to the database',
			'handler' => \&accessory_type
		}
	},
	enlarger => {
		'add' => {
			'desc' => 'Add a new enlarger to the database',
			'handler' => \&enlarger_add,
		},
		'sell' => {
			'desc' => 'Sell an enlarger',
			'handler' => \&enlarger_sell
		}
	},
	flash => {
		'add' => {
			'desc' => 'Add a new flash to the database',
			'handler' => \&flash_add
		}
	},
	battery => {
		'add' => {
			'desc' => 'Add a new type of battery to the database',
			'handler' => \&battery_add
		}
	},
	format => {
		'add' => {
			'desc' => 'Add a new film format to the database',
			'handler' => \&format_add
		}
	},
	negativesize => {
		'add' => {
			'desc' => 'Add a size of negative to the database',
			'handler' => \&negativesize_add
		}
	},
	lightmeter => {
		'add' => {
			'desc' => 'Add a new light meter to the database',
			'handler' => \&lightmeter_add
		}
	},
	process => {
		'add' => {
			'desc' => 'Add a new development process to the database',
			'handler' => \&process_add
		}
	},
	archive => {
		'add' => {
			'desc' => 'Add a new physical archive for prints or films',
			'handler' => \&archive_add,
		},
		'list' => {
			'desc' => 'List the contents of an archive',
			'handler' => \&archive_list,
		},
		'move' => {
			'desc' => 'Move an archive to a new location',
			'handler' => \&archive_move,
		},
		'films' => {
			'desc' => 'Bulk-add multiple films to an archive',
			'handler' => \&archive_films,
		},
		'seal' => {
			'desc' => 'Seal an archive and prevent new items from being added to it',
			'handler' => \&archive_seal,
		},
		'unseal' => {
			'desc' => 'Unseal an archive and allow new items to be added to it',
			'handler' => \&archive_unseal
		}
	}
);

# Read in and verify command
my $command = $ARGV[0] or &nocommand(\%handlers);
if (!exists $handlers{$command}) {
	&nocommand(\%handlers);
}

# Read in and verify subcommand
my $subcommand = $ARGV[1] or &nosubcommand(\%{$handlers{$command}}, $command);
if (!exists $handlers{$command}{$subcommand}) {
	&nosubcommand(\%{$handlers{$command}}, $command);
}

# Execute chosen handler
$handlers{$command}{$subcommand}{'handler'}->($db);
