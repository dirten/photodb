#!/usr/bin/perl -wT

# Interactive user interface for interacting with the photography database

use strict;
use warnings;
use Switch;
use DBI;
use DBD::mysql;
use SQL::Abstract;

use lib 'lib';
use funcs;
use queries;
use handlers;

# Connect to DB - for now this is a global
my $db = &db;

# Define handlers for each command
my %handlers = (
	'film' => {
		'add'     => { 'handler' => \&film_add,     'desc' => 'Add a new film to the database' },
		'load'    => { 'handler' => \&film_load,    'desc' => 'Load a film into a camera' },
		'develop' => { 'handler' => \&film_develop, 'desc' => 'Develop a film' },
		'tag'     => { 'handler' => \&film_tag,     'desc' => 'Write EXIF tags to scans from a film' },
		'archive' => { 'handler' => \&film_archive, 'desc' => 'Put the film in a physical archive' },
		'locate'  => { 'handler' => \&film_locate,  'desc' => 'Locate where this film is' }
	},
	camera => {
		'add'          => { 'handler' => \&camera_add,         'desc' => 'Add a new camera to the database' },
		'display-lens' => { 'handler' => \&camera_displaylens, 'desc' => 'Associate a camera with a lens for display purposes' },
		'show-lenses'  => { 'handler' => \&notimplemented,     'desc' => 'Not yet implemented' },
		'sell'         => { 'handler' => \&camera_sell,        'desc' => 'Sell a camera' },
		'repair'       => { 'handler' => \&camera_repair,      'desc' => 'Repair a camera' },
		'stats'        => { 'handler' => \&camera_stats,       'desc' => 'Show statistics about a camera' },
	},
	negative => {
		'add'      => { 'handler' => \&negative_add,     'desc' => 'Add a new negative to the database as part of a film' },
		'bulk-add' => { 'handler' => \&negative_bulkadd, 'desc' => 'Bulk add multiple negatives to the database as part of a film' }
	},
	mount => {
		'add'   => { 'handler' => \&mount_add,   'desc' => 'Add a new lens mount to the database' },
		'view'  => { 'handler' => \&mount_view,  'desc' => 'View compatible cameras and lenses for a mount' },
	},
	lens => {
		'add'    => { 'handler' => \&lens_add,    'desc' => 'Add a new lens to the database' },
		'sell'   => { 'handler' => \&lens_sell,   'desc' => 'Sell a lens' },
		'repair' => { 'handler' => \&lens_repair, 'desc' => 'Repair a lens' },
		'stats'  => { 'handler' => \&lens_stats,  'desc' => 'Show statistics about a lens' }
	},
	print => {
		'add'     => { 'handler' => \&print_add,     'desc' => 'Add a new print that has been made from a negative' },
		'tone'    => { 'handler' => \&print_tone,    'desc' => 'Add toning to a print' },
		'sell'    => { 'handler' => \&print_sell,    'desc' => 'Sell a print' },
		'order'   => { 'handler' => \&print_order,   'desc' => 'Register an order for a print' },
		'fulfil'  => { 'handler' => \&print_fulfil,  'desc' => 'Fulfil an order for a print' },
		'archive' => { 'handler' => \&print_archive, 'desc' => 'Add a print to a physical archive' },
		'locate'  => { 'handler' => \&print_locate,  'desc' => 'Locate a print in an archive' }
	},
	material => {
		'paperstock' => { 'handler' => \&paperstock_add, 'desc' => 'Add a new type of photo paper to the database' },
		'developer'  => { 'handler' => \&developer_add,  'desc' => 'Add a new developer to the database' },
		'toner'      => { 'handler' => \&toner_add,      'desc' => 'Add a new chemical toner to the database' },
		'filmstock'  => { 'handler' => \&filmstock_add,  'desc' => 'Add a new type of filmstock to the database' }
	},
	task => {
		'run' => { 'handler' => \&task_run, 'desc' => 'Run a selection of maintenance tasks on the database' }
	},
	accessory => {
		'add'           => { 'handler' => \&accessory_add,     'desc' => 'Add a new "other" accessory to the database' },
		'type'          => { 'handler' => \&accessory_type,    'desc' => 'Add a new type of "other" accessory to the database' },
		'flash'         => { 'handler' => \&flash_add,         'desc' => 'Add a new flash to the database' },
		'battery'       => { 'handler' => \&battery_add,       'desc' => 'Add a new type of battery to the database' },
		'meter'         => { 'handler' => \&lightmeter_add,    'desc' => 'Add a new light meter to the database' },
		'teleconverter' => { 'handler' => \&teleconverter_add, 'desc' => 'Add a new teleconverter to the database' },
		'filter'        => { 'handler' => \&filter_add,        'desc' => 'Add a new (optical) filter to the database' },
		'filteradapter' => { 'handler' => \&filter_adapt,      'desc' => 'Add a filter adapter to the database' },
		'mountadapter'  => { 'handler' => \&mount_adapt,       'desc' => 'Add a new mount adapter to the database' },
	},
	enlarger => {
		'add'  => { 'handler' => \&enlarger_add,  'desc' => 'Add a new enlarger to the database' },
		'sell' => { 'handler' => \&enlarger_sell, 'desc' => 'Sell an enlarger' }
	},
	archive => {
		'add'    => { 'handler' => \&archive_add,    'desc' => 'Add a new physical archive for prints or films' },
		'list'   => { 'handler' => \&archive_list,   'desc' => 'List the contents of an archive' },
		'move'   => { 'handler' => \&archive_move,   'desc' => 'Move an archive to a new location' },
		'films'  => { 'handler' => \&archive_films,  'desc' => 'Bulk-add multiple films to an archive' },
		'seal'   => { 'handler' => \&archive_seal,   'desc' => 'Seal an archive and prevent new items from being added to it' },
		'unseal' => { 'handler' => \&archive_unseal, 'desc' => 'Unseal an archive and allow new items to be added to it' }
	},
	data => {
		'format'        => { 'handler' => \&format_add,         'desc' => 'Add a new film format to the database' },
		'negsize'       => { 'handler' => \&negativesize_add,   'desc' => 'Add a size of negative to the database' },
		'process'       => { 'handler' => \&process_add,        'desc' => 'Add a new development process to the database' },
		'manufacturer'  => { 'handler' => \&manufacturer_add,   'desc' => 'Add a new manufacturer to the database' },
		'bodytype'      => { 'handler' => \&camera_addbodytype, 'desc' => 'Add a new camera body type' },
		'shuttertype'   => { 'handler' => \&shuttertype_add,    'desc' => 'Add a new type of shutter to the database' },
		'shutterspeed'  => { 'handler' => \&shutterspeed_add,   'desc' => 'Add a new shutter speed to the database' },
		'focustype'     => { 'handler' => \&focustype_add,      'desc' => 'Add a new type of focus system to the database' },
		'flashprotocol' => { 'handler' => \&flashprotocol_add,  'desc' => 'Add a new flash protocol to the database' },
		'meteringtype'  => { 'handler' => \&meteringtype_add,   'desc' => 'Add a new type of metering system to the database' },
	}
);

# Read in and verify command
my $command = $ARGV[0] or &nocommand(\%handlers);
if (!exists $handlers{$command}) {
	&nocommand(\%handlers);
}

# Read in and verify subcommand
my $subcommand = $ARGV[1] or &nosubcommand(\%{$handlers{$command}}, $command);
if (!exists $handlers{$command}{$subcommand}) {
	&nosubcommand(\%{$handlers{$command}}, $command);
}

# Execute chosen handler
$handlers{$command}{$subcommand}{'handler'}->($db);
